# photoprism-guide
Configure reverse proxy using nginx for photoprism on umbrel server behind CGNAT using ngrok

Before starting, you should have an umbrel server with photoprism installed.

1. Installing NGINX & Certbot

Begin by establishing an ssh connection to your umbrel.  Before installing, update your package repository list.

```
sudo apt update
```

Then, install the required components.

```
sudo apt install python3-acme python3-certbot python3-mock python3-openssl python3-pkg-resources python3-pyparsing python3-zope.interface python3-certbot-nginx nginx
```

The installation will fail; this is expected behavior. It is happening because Umbrel is already claiming port 80. Therefore, we need to change this in the configuration and finish the installation.

```
sudo sed -i 's/80 default_server/15080/g' /etc/nginx/sites-available/default
```

Then, finish the installation.

```
sudo apt install -f
```

2. Create ngrok tunnel

Using tmux (or screen, etc.), create a new window.

```
tmux new -s ngrok
```

Create an http tunnel on port 15080

```
ngrok http 15080
```

Copy the url generated by ngrok.  We will need this later.  Exit tmux.

3. Creating the photoprism server configuration for NGINX

Create a new configuration file:

```
sudo vi /etc/nginx/sites-available/photoprism
```

Paste in the following contents:

```
proxy_buffer_size          128k;
proxy_buffers              4 256k;
proxy_busy_buffers_size    256k;
client_header_buffer_size 500k;
large_client_header_buffers 4 500k;
http2_max_field_size       500k;
http2_max_header_size      500k;
client_max_body_size       500M;


map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

server {
    server_name <url here>;

    location / {
        proxy_pass http://127.0.0.1:8087;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }

    listen 15080;
    listen [::]:15080;
}
```

Note: Pay attention to changing `<url here>` in this configuration file.

Save the file and exit the editor.

Then, enable the configuration:

```
sudo ln -s /etc/nginx/sites-available/photoprism /etc/nginx/sites-enabled/
```

Test the validity of the configuration using:

```
sudo nginx -t
```

Then, reload the configuration.

```
sudo systemctl reload nginx.service
```

4. Request a new SSL certificate from LetsEncrypt

Request a new certificate from LetsEncrypt.

```
sudo certbot --nginx -d <url here> --agree-tos --tls-sni-01-port 15443 --http-01-port 15080
```

Note: Make sure to replace `<url here>`
  
When Certbot asks you about redirecting, choose 1: No redirect.

5. Manually add the HTTP-redirect
  
The goal of this step is to force users to use our new, secure, connection to the photoprism server. When you add this block, all traffic headed for the non-secure port 15080 will be redirected through HTTP to secure port 15443.

Open up the configuration file again:

```
sudo vi /etc/nginx/sites-available/photoprism
```
  
Then, at the end of the file, add this server block:
  
```
server {
    if ($host = <url here>) {
        return 301 https://$host$request_uri;
    }

    listen 15080;
    listen [::]:15080;

    server_name <url here>;
    return 404;
}
```
  
Note: Replace the two occurrences of `<url here>`.

Then, validate & reload the configuration:
  
```
sudo nginx -t
```
  
Your photoprism should now be accessible using SSL.
  
# Notes
  
This process will have to be repeated if your ngrok connection is broken (unless you have the paid version and use a dedicated hostname on startup).
  
Regardless, I recommend using https://remote.it/ to maintain an ssh connection to your umbrel from outside your local network to fix any issues you run into.
  
Good luck!
